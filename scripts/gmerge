#!/usr/bin/env ganga
import os
import argparse
import tempfile
import Ganga
from gutils.utils import subjobs
from gutils.merge import direct_merge

parser = argparse.ArgumentParser(description='Directly merge outputfiles')
parser.add_argument('jobs', nargs='+', help='Job IDs. One output per argument. Use comma separated values for merge accross (sub)jobs.')
parser.add_argument('--name', '-n', required=True, help='Name of job output file in job.outputfiles')
parser.add_argument('--output', '-o', default=tempfile.gettempdir(), help='Where to put the merged file? Defaults to $TMPDIR')
parser.add_argument('--overwrite', action='store_true', help='Overwrite existing output file')
parser.add_argument('--ignore-missing', action='store_true', help='Ignore missing output files, e.g. due to failed jobs')
args = parser.parse_args()

if not os.path.isdir(args.output):
    parser.error('Ouput (--output) must be an existing directory!')

for spec in args.jobs:
    ids = spec.split(',')
    jobs = [Ganga.GPI.jobs(i) for i in ids]
    unique_names = list(set(j.name for j in subjobs(jobs)))
    print 'Downloading/merging files for job(s)', unique_names

    direct_merge(jobs, args.name, args.output, overwrite=args.overwrite, ignore_missing=args.ignore_missing)

print 'Your merged files are at', args.output
